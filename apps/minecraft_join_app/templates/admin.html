<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Subscription Admin</title>
    <style>
      :root {
        color-scheme: light;
      }
      body {
        font-family: Arial, sans-serif;
        padding: 24px;
        background: #f6f3ee;
        color: #1d1b18;
      }
      .shell {
        max-width: 960px;
        margin: 0 auto;
      }
      .card {
        background: #ffffff;
        border: 1px solid #d8d0c5;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(31, 26, 21, 0.08);
      }
      h1 {
        margin-top: 0;
      }
      form {
        display: grid;
        gap: 12px;
      }
      label {
        font-weight: 600;
      }
      input,
      button,
      select {
        font-size: 1rem;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #c9c1b7;
      }
      button {
        background: #2f5e4e;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      button.secondary {
        background: #7a4c3d;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .error {
        color: #b00020;
        margin: 0 0 12px;
      }
      .success {
        color: #0a6d2d;
        margin: 0 0 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid #e2dbd1;
      }
      th {
        background: #f0e8de;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: #e7ded3;
      }
      .pill.active {
        background: #2f5e4e;
        color: #fff;
      }
      .pill.inactive {
        background: #8c4b4b;
        color: #fff;
      }
      .pill.pending {
        background: #c5892b;
        color: #fff;
      }
      .actions form {
        display: inline;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="card">
        <h1>Subscription Admin</h1>
        <% if (error) { %>
          <p class="error"><%= error %></p>
        <% } %>
        <% if (success) { %>
          <p class="success"><%= success %></p>
        <% } %>

        <% if (!is_admin) { %>
          <form method="post" action="/admin/login">
            <label for="password">Admin password</label>
            <input id="password" name="password" type="password" required />
            <button type="submit">Sign in</button>
          </form>
        <% } else { %>
          <form method="post" action="/admin/logout">
            <button class="secondary" type="submit">Sign out</button>
          </form>
        <% } %>
      </div>

      <% if (is_admin) { %>
        <% const pending_list = subscriptions.filter(s => s.pending); %>
        <% const active_list = subscriptions.filter(s => !s.pending); %>
        <div class="card">
          <h2>Add or update a subscription</h2>
          <form method="post" action="/admin/subscription">
            <div class="row">
              <div>
                <label for="mc_name">Minecraft name</label>
                <input id="mc_name" name="mc_name" required />
              </div>
              <div>
                <label for="payment_date">Payment date</label>
                <input id="payment_date" name="payment_date" type="date" value="<%= today %>" required />
              </div>
              <div>
                <label for="duration_days">Duration (days)</label>
                <input id="duration_days" name="duration_days" type="number" min="1" value="30" required />
              </div>
              <div>
                <label for="active">Active now</label>
                <input id="active" name="active" type="checkbox" checked />
              </div>
            </div>
            <button type="submit">Save subscription</button>
          </form>
        </div>

        <div class="card">
          <h2>Pending requests</h2>
          <% if (pending_list.length > 0) { %>
            <table>
              <thead>
                <tr>
                  <th>Minecraft name</th>
                  <th>Requested at</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% pending_list.forEach(entry => { %>
                  <tr>
                    <td><%= entry.mc_name %></td>
                    <td><%= entry.requested_at || "-" %></td>
                    <td><span class="pill pending">Pending</span></td>
                    <td class="actions">
                      <button
                        class="secondary"
                        type="button"
                        data-edit
                        data-mc-name="<%= entry.mc_name %>"
                        data-payment-date="<%= entry.payment_date || '' %>"
                        data-duration-days="<%= entry.duration_days || '' %>"
                        data-active="<%= entry.active ? 'true' : 'false' %>"
                      >
                        Activate
                      </button>
                      <form method="post" action="/admin/subscription/<%= entry.mc_name %>/delete">
                        <button class="secondary" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          <% } else { %>
            <p>No pending requests.</p>
          <% } %>
        </div>

        <div class="card">
          <h2>Current subscriptions</h2>
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="Search by Minecraft name" />
          <% if (active_list.length > 0) { %>
            <table>
              <thead>
                <tr>
                  <th>Minecraft name</th>
                  <th>Payment date</th>
                  <th>End date</th>
                  <th>Duration</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% active_list.forEach(entry => { %>
                  <tr>
                    <td><%= entry.mc_name %></td>
                    <td><%= entry.payment_date || "-" %></td>
                    <td><%= entry.end_date || "-" %></td>
                    <td>
                      <% if (entry.duration_days) { %>
                        <%= entry.duration_days %> days
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td>
                      <% if (entry.active) { %>
                        <span class="pill active">Active</span>
                      <% } else { %>
                        <span class="pill inactive">Inactive</span>
                      <% } %>
                    </td>
                    <td class="actions">
                      <button
                        class="secondary"
                        type="button"
                        data-edit
                        data-mc-name="<%= entry.mc_name %>"
                        data-payment-date="<%= entry.payment_date || '' %>"
                        data-duration-days="<%= entry.duration_days || '' %>"
                        data-active="<%= entry.active ? 'true' : 'false' %>"
                      >
                        Edit
                      </button>
                      <form method="post" action="/admin/subscription/<%= entry.mc_name %>/delete">
                        <button class="secondary" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          <% } else { %>
            <p>No subscriptions yet.</p>
          <% } %>
        </div>

        <div class="card">
          <h2>Audit log</h2>
          <% if (log_entries.length > 0) { %>
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Action</th>
                  <th>Details</th>
                  <th>IP</th>
                </tr>
              </thead>
              <tbody>
                <% log_entries.forEach(entry => { %>
                  <tr>
                    <td><%= entry.timestamp %></td>
                    <td><%= entry.action %></td>
                    <td><%= JSON.stringify(entry.details) %></td>
                    <td><%= entry.ip %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          <% } else { %>
            <p>No log entries yet.</p>
          <% } %>
        </div>
      <% } %>
    </div>
    <script>
      const searchInput = document.querySelector("#search");
      const rows = document.querySelectorAll("tbody tr");
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          const query = searchInput.value.toLowerCase().trim();
          rows.forEach((row) => {
            const name = row.querySelector("td")?.textContent?.toLowerCase() || "";
            row.style.display = name.includes(query) ? "" : "none";
          });
        });
      }

      const editButtons = document.querySelectorAll("[data-edit]");
      editButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const mcName = button.getAttribute("data-mc-name") || "";
          const paymentDate = button.getAttribute("data-payment-date") || "";
          const durationDays = button.getAttribute("data-duration-days") || "";
          const active = button.getAttribute("data-active") === "true";

          document.querySelector("#mc_name").value = mcName;
          document.querySelector("#payment_date").value = paymentDate;
          document.querySelector("#duration_days").value = durationDays;
          document.querySelector("#active").checked = active;
          document.querySelector("#mc_name").focus();
        });
      });
    </script>
  </body>
</html>
